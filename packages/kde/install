#!/bin/bash

set -eu

export PATH="${PACKAGE_SOURCE_DIR}/bin:${PATH}"

IGNORED_DEPS=''
if dotfiles-package-installed laptop-mode-tools; then
    IGNORED_DEPS='power-profiles-daemon-'
fi

sudo apt-get update
sudo apt-get -y --no-remove install kde-plasma-desktop okular \
    plasma-workspace-wayland sddm- unattended-upgrades- ${IGNORED_DEPS}

kwriteconfig5 --file "${HOME}/.config/kdeglobals" --group KDE --key SingleClick --type bool false
kwriteconfig5 --file "${HOME}/.config/kdeglobals" --group KDE --key ScrollbarLeftClickNavigatesByPage --type bool false

kwriteconfig5 --file "${HOME}/.config/ksmserverrc" --group General --key loginMode emptySession

kwriteconfig5 --file "${HOME}/.config/kscreenlockerrc" --group Daemon --key LockGrace 0

kwriteconfig5 --file "${HOME}/.config/kwinrc" --group Effect-windowview --key BorderActivateAll 9

kwriteconfig5 --file "${HOME}/.config/systemsettingsrc" --group systemsettings_sidebar_mode --key HighlightNonDefaultSettings --type bool true

kwriteconfig5 --file "${HOME}/.config/krunnerrc" --group Plugins --key PowerDevilEnabled --type bool false
kwriteconfig5 --file "${HOME}/.config/krunnerrc" --group Plugins --key appstreamEnabled --type bool false
kwriteconfig5 --file "${HOME}/.config/krunnerrc" --group Plugins --key baloosearchEnabled --type bool false
kwriteconfig5 --file "${HOME}/.config/krunnerrc" --group Plugins --key browserhistoryEnabled --type bool false
kwriteconfig5 --file "${HOME}/.config/krunnerrc" --group Plugins --key browsertabsEnabled --type bool false
kwriteconfig5 --file "${HOME}/.config/krunnerrc" --group Plugins --key desktopsessionsEnabled --type bool false
kwriteconfig5 --file "${HOME}/.config/krunnerrc" --group Plugins --key org.kde.windowedwidgetsEnabled --type bool false
kwriteconfig5 --file "${HOME}/.config/krunnerrc" --group Plugins --key webshortcutsEnabled --type bool false

kwriteconfig5 --file "${HOME}/.config/dolphinrc" --group General --key RememberOpenedTabs --type bool false
kwriteconfig5 --file "${HOME}/.config/dolphinrc" --group ContentDisplay --key UseShortRelativeDates --type bool false

kwriteconfig5 --file "${HOME}/.config/konsolerc" --group KonsoleWindow --key RememberWindowSize --type bool false

kwriteconfig5 --file "${HOME}/.config/kwriterc" --group General --key 'Show welcome view for new window' --type bool false
kwriteconfig5 --file "${HOME}/.config/kwriterc" --group 'KTextEditor Document' --key 'On-The-Fly Spellcheck' --type bool true
kwriteconfig5 --file "${HOME}/.config/kwriterc" --group 'KTextEditor Document' --key 'Show Spaces' 1
kwriteconfig5 --file "${HOME}/.config/kwriterc" --group 'KTextEditor Renderer' --key 'Word Wrap Marker' --type bool true
kwriteconfig5 --file "${HOME}/.config/kwriterc" --group 'KTextEditor View' --key 'Auto Brackets' --type bool false
# Yes that's 'shoe' not 'show'
kwriteconfig5 --file "${HOME}/.config/kwriterc" --group 'KTextEditor View' --key 'Shoe Line Ending Type in Statusbar' --type bool true

ACTIVITY="$(kactivities-cli --bare --current-activity)"
APPLET_FILE='plasma-org.kde.plasma.desktop-appletsrc'
ICON_APPLETS=''

function add-panel-icon() {
    local APPLET_NUMBER="${1}"
    local DIR
    DIR="$(dirname "${2}")"
    local DESKTOP_FILE
    DESKTOP_FILE="$(basename "${2}")"

    sed "s|@@@@@1@@@@@|${APPLET_NUMBER}|g" <"${PACKAGE_SOURCE_DIR}/appletsrc-icon" |
        sed "s|@@@@@2@@@@@|${HOME}|g" |
        sed "s|@@@@@3@@@@@|${DESKTOP_FILE}|g" |
        sed "s|@@@@@4@@@@@|${DIR}|g"
    echo

    ICON_APPLETS="${ICON_APPLETS}${APPLET_NUMBER};"
}

{
    sed "s|@@@@@1@@@@@|${ACTIVITY}|g" <"${PACKAGE_SOURCE_DIR}/appletsrc-header"
    echo

    add-panel-icon 30 '/usr/share/applications/org.kde.konsole.desktop'
    add-panel-icon 31 '/usr/share/applications/org.kde.dolphin.desktop'

    if dotfiles-package-installed chrome; then
        add-panel-icon 32 "${HOME}/.local/share/applications/google-chrome.desktop"
    fi

    if dotfiles-package-installed emacs; then
        add-panel-icon 33 "${HOME}/.local/share/applications/emacs-daemon.desktop"
    fi

    sed "s|@@@@@1@@@@@|${ICON_APPLETS}|g" <"${PACKAGE_SOURCE_DIR}/appletsrc-footer"
} >"${PACKAGE_INSTALL_DIR}/${APPLET_FILE}"

cp "${PACKAGE_INSTALL_DIR}/${APPLET_FILE}" "${HOME}/.config/${APPLET_FILE}"

xdg-desktop-menu install --novendor "${PACKAGE_SOURCE_DIR}/dotfiles-toggle-kde-theme.desktop"

if ! dotfiles-package-installed emacs; then
    xdg-mime default org.kde.kwrite.desktop \
        text/english \
        text/plain \
        text/x-makefile \
        text/x-c++hdr \
        text/x-c++src \
        text/x-chdr \
        text/x-csrc \
        text/x-java \
        text/x-moc \
        text/x-pascal \
        text/x-tcl \
        text/x-tex \
        application/x-shellscript \
        text/x-c \
        text/x-c++ \
        text/markdown
fi

function bind-key() {
    local GROUP="${1}"
    local KEY="${2}"
    local BINDING="${3}"
    kwriteconfig5 --file "${HOME}/.config/kglobalshortcutsrc" --group "${GROUP}" --key "${KEY}" "${BINDING},${BINDING},${KEY}"
}

function unbind-key() {
    bind-key "${1}" "${2}" 'none'
}

function launcher-key() {
    local DESKTOP_FILE="${1}"
    local NAME="${2}"
    local BINDING="${3}"
    kwriteconfig5 --file "${HOME}/.config/kglobalshortcutsrc" --group "${DESKTOP_FILE}" --key '_k_friendly_name' "${NAME}"
    kwriteconfig5 --file "${HOME}/.config/kglobalshortcutsrc" --group "${DESKTOP_FILE}" --key '_launch' "${BINDING},none,${NAME}"
}

bind-key 'ksmserver' 'Lock Session' 'Ctrl+Alt+L'
bind-key 'kwin' 'Walk Through Windows of Current Application (Reverse)' 'Alt+Â¬'
bind-key 'kwin' 'Window Operations Menu' 'Alt+Space'
unbind-key 'kwin' 'Window Quick Tile Bottom'
unbind-key 'kwin' 'Window Quick Tile Left'
unbind-key 'kwin' 'Window Quick Tile Right'
unbind-key 'kwin' 'Window Quick Tile Top'
bind-key 'mediacontrol' 'nextmedia' 'Ctrl+Alt+.'
bind-key 'mediacontrol' 'previousmedia' 'Ctrl+Alt+\,'
bind-key 'mediacontrol' 'playpausemedia' 'Ctrl+Alt+Space'
bind-key 'org.kde.krunner.desktop' '_launch' 'Alt+F2'

launcher-key 'emacs-daemon.desktop' 'GNU Emacs (Daemon Mode)' 'Ctrl+Alt+E'
launcher-key 'google-chrome.desktop' 'Google Chrome' 'Ctrl+Alt+B'
launcher-key 'vlc.desktop' 'VLC' 'Ctrl+Alt+M'
launcher-key 'org.kde.dolphin.desktop' 'Dolphin' 'Ctrl+Alt+H'
launcher-key 'gnucash.desktop' 'GnuCash' 'Ctrl+Alt+G'
launcher-key 'org.gnome.Calculator.desktop' 'Calculator' 'Ctrl+Alt+C'
launcher-key 'codium.desktop' 'VSCodium' 'Ctrl+Alt+V'
launcher-key 'discord.desktop' 'Discord' 'Ctrl+Alt+D'
# shellcheck disable=1003
launcher-key 'dotfiles-toggle-kde-theme.desktop' 'Toggle Theme' 'Ctrl+Alt+\\'

dotfiles-set-kde-theme dark
